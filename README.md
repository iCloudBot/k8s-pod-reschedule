# Kubernetes Pod å¼‚å¸¸è‡ªåŠ¨é‡è°ƒåº¦å·¥å…·

[![Python Version](https://img.shields.io/badge/python-3.7+-blue.svg)](https://www.python.org/downloads/)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)
[![Platform](https://img.shields.io/badge/platform-Linux%20%7C%20Windows-lightgrey.svg)](https://github.com)

ä¸€ä¸ªç”Ÿäº§çº§çš„ Kubernetes Pod å¼‚å¸¸ç›‘æ§ä¸è‡ªåŠ¨é‡è°ƒåº¦è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒèŠ‚ç‚¹æ•…éšœè‡ªåŠ¨éš”ç¦»ã€Pod å¼‚å¸¸è‡ªåŠ¨æ¢å¤ã€èŠ‚ç‚¹æ¢å¤è‡ªåŠ¨è§£é™¤éš”ç¦»ã€‚

---

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½

- âœ… **Pod å¼‚å¸¸ç›‘æ§**ï¼šå®æ—¶ç›‘æ§ Pod çŠ¶æ€ï¼Œæ”¯æŒè‡ªå®šä¹‰å¼‚å¸¸çŠ¶æ€åˆ—è¡¨
- âœ… **èŠ‚ç‚¹æ•…éšœæ£€æµ‹**ï¼šæ¯åˆ†é’Ÿä¸»åŠ¨æ£€æµ‹èŠ‚ç‚¹å¥åº·çŠ¶æ€
- âœ… **è‡ªåŠ¨èŠ‚ç‚¹éš”ç¦»**ï¼šå‘ç°å¼‚å¸¸èŠ‚ç‚¹ç«‹å³æ‰§è¡Œ `cordon` + `taint`
- âœ… **å¼ºåˆ¶ Pod æ¸…ç†**ï¼šåœ¨æœ‰å¯ç”¨èŠ‚ç‚¹çš„å‰æä¸‹ï¼Œå¼ºåˆ¶æ¸…ç†å¼‚å¸¸èŠ‚ç‚¹ä¸Šçš„ Pod
- âœ… **èŠ‚ç‚¹è‡ªåŠ¨æ¢å¤**ï¼šèŠ‚ç‚¹æ¢å¤åè‡ªåŠ¨ç§»é™¤æ±¡ç‚¹å¹¶æ¢å¤è°ƒåº¦
- âœ… **æ™ºèƒ½ç¼“å­˜ç®¡ç†**ï¼šPod æ­£å¸¸æ—¶è‡ªåŠ¨æ¸…ç†ç¼“å­˜ï¼Œé‡Šæ”¾å†…å­˜
- âœ… **è·¨å¹³å°æ”¯æŒ**ï¼šæ”¯æŒ Linux / Windows / macOS

### æ”¯æŒçš„å·¥ä½œè´Ÿè½½

- `Deployment`
- `StatefulSet`
- `ReplicaSet`

### Podç›‘æ§çš„å¼‚å¸¸çŠ¶æ€

```
NotReady, Terminating, Waiting, Pending, ContainerCreating,
PodInitializing, Error, Unknown, CrashLoopBackOff,
ImagePullBackOff, ErrImagePull, CreateContainerError,
CreateContainerConfigError
```

---

## ğŸ”§ å·¥ä½œåŸç†

### å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ¯ 90 ç§’æ‰§è¡Œä¸€æ¬¡                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. æ£€æŸ¥æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€                                         â”‚
â”‚     â”œâ”€ NotReady + å¯è°ƒåº¦ + æ— æ±¡ç‚¹ â†’ ç«‹å³éš”ç¦» + å¼ºåˆ¶æ¸…ç† Pod  â”‚
â”‚     â”œâ”€ NotReady + å·²éš”ç¦» + æœ‰æ±¡ç‚¹ â†’ æ¸…ç†æ®‹ç•™ Pod             â”‚
â”‚     â””â”€ Ready + å·²éš”ç¦» + æœ‰æ±¡ç‚¹ â†’ æ ‡è®°ä¸ºå¾…æ¢å¤                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æ£€æŸ¥å·²æ•‘æ´èŠ‚ç‚¹                                          â”‚
â”‚     â””â”€ èŠ‚ç‚¹æ¢å¤ Ready â†’ ç§»é™¤æ±¡ç‚¹ + uncordon                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. æ£€æŸ¥æ‰€æœ‰ Pod çŠ¶æ€                                       â”‚
â”‚     â””â”€ è¶…è¿‡é˜ˆå€¼ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰â†’ æ‰§è¡Œ scale 0 â†’ åŸå‰¯æœ¬æ•°      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### èŠ‚ç‚¹éš”ç¦»æœºåˆ¶

```bash
# å‘ç°å¼‚å¸¸èŠ‚ç‚¹æ—¶
kubectl cordon <node>                                    # ç¦æ­¢æ–° Pod è°ƒåº¦
kubectl taint nodes <node> node-role.kubernetes.io/RescuePod=true:NoSchedule  # æ ‡è®°æ±¡ç‚¹

# å¦‚æœæœ‰å¯ç”¨èŠ‚ç‚¹ï¼ˆReady + Schedulable > 0ï¼‰
kubectl delete pod <pod> --force --grace-period=0        # å¼ºåˆ¶æ¸…ç†æœ‰æ§åˆ¶å™¨çš„ Pod

# èŠ‚ç‚¹æ¢å¤å
kubectl taint nodes <node> node-role.kubernetes.io/RescuePod:NoSchedule-  # ç§»é™¤æ±¡ç‚¹
kubectl uncordon <node>                                  # æ¢å¤è°ƒåº¦
```

### Pod é‡è°ƒåº¦ç­–ç•¥

| æ§åˆ¶å™¨ç±»å‹          | èŠ‚ç‚¹æ­£å¸¸           | èŠ‚ç‚¹å¼‚å¸¸           |
| -------------- | -------------- | -------------- |
| Deployment     | Scale 0 â†’ åŸå‰¯æœ¬æ•° | Scale 0 â†’ åŸå‰¯æœ¬æ•° |
| StatefulSet    | Scale 0 â†’ åŸå‰¯æœ¬æ•° | Scale 0 â†’ åŸå‰¯æœ¬æ•° |
| ReplicaSet     | Scale 0 â†’ åŸå‰¯æœ¬æ•° | Scale 0 â†’ åŸå‰¯æœ¬æ•° |
| Terminating è¶…æ—¶ | å¼ºåˆ¶åˆ é™¤           | å¼ºåˆ¶åˆ é™¤           |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Python 3.7+
- kubectlï¼ˆå·²é…ç½®å¹¶èƒ½è®¿é—® K8s é›†ç¾¤ï¼‰
- è¶³å¤Ÿçš„ RBAC æƒé™

### å®‰è£…

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/iCloudBot/k8s-pod-reschedule.git
cd k8s-pod-reschedule

# æ— éœ€é¢å¤–ä¾èµ–ï¼Œä½¿ç”¨ Python æ ‡å‡†åº“
python3 --version  # ç¡®è®¤ Python ç‰ˆæœ¬
```

## âš™ï¸ é…ç½®è¯´æ˜

### å‘½ä»¤è¡Œå‚æ•°

| å‚æ•°                     | ç¯å¢ƒå˜é‡                     | é»˜è®¤å€¼                                     | è¯´æ˜              |
| ---------------------- | ------------------------ | --------------------------------------- | --------------- |
| `--interval`           | `CHECK_INTERVAL`         | 90                                      | æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰         |
| `--threshold`          | `POD_ABNORMAL_THRESHOLD` | 300                                     | Pod å¼‚å¸¸é˜ˆå€¼ï¼ˆç§’ï¼‰     |
| `--log-dir`            | `LOG_DIR`                | /var/log/k8s-pod-reschedule             | æ—¥å¿—ç›®å½•            |
| `--namespaces`         | `MONITOR_NAMESPACES`     | æ‰€æœ‰                                      | ç›‘æ§çš„å‘½åç©ºé—´ï¼ˆé€—å·åˆ†éš”ï¼‰   |
| `--exclude-namespaces` | `EXCLUDE_NAMESPACES`     | kube-system,kube-public,kube-node-lease | æ’é™¤çš„å‘½åç©ºé—´         |
| `--scale-wait`         | `SCALE_WAIT_SECONDS`     | 5                                       | Scale æ“ä½œç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰ |

**é…ç½®ä¼˜å…ˆçº§ï¼š** ç¯å¢ƒå˜é‡ > å‘½ä»¤è¡Œå‚æ•° > é»˜è®¤å€¼

### é…ç½®ç¤ºä¾‹

**1. ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆæ¨èå®¹å™¨åŒ–éƒ¨ç½²ï¼‰**

```bash
export CHECK_INTERVAL=60
export POD_ABNORMAL_THRESHOLD=180
export MONITOR_NAMESPACES="default,production"
export EXCLUDE_NAMESPACES="kube-system,monitoring"
python3 main.py
```

**2. ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°**

```bash
python3 pod-rescue.py \
  --interval 60 \
  --threshold 180 \
  --namespaces "default,production" \
  --exclude-namespaces "kube-system,monitoring"
```

**3. æ··åˆä½¿ç”¨ï¼ˆç¯å¢ƒå˜é‡ä¼˜å…ˆï¼‰**

```bash
export CHECK_INTERVAL=60
python3 pod-rescue.py --threshold 180
# å®é™…: CHECK_INTERVAL=60, POD_ABNORMAL_THRESHOLD=180
```

## ğŸ“– ä½¿ç”¨æŒ‡å—

### æ‰‹åŠ¨å¹²é¢„

```bash
# æŸ¥çœ‹è¢«éš”ç¦»çš„èŠ‚ç‚¹
kubectl get nodes | grep SchedulingDisabled

# æŸ¥çœ‹èŠ‚ç‚¹æ±¡ç‚¹
kubectl describe node <node-name> | grep Taints

# æ‰‹åŠ¨ç§»é™¤æ±¡ç‚¹ï¼ˆå¦‚æœéœ€è¦ï¼‰
kubectl taint nodes <node-name> node-role.kubernetes.io/RescuePod:NoSchedule-

# æ‰‹åŠ¨æ¢å¤è°ƒåº¦
kubectl uncordon <node-name>
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. kubectl æƒé™ä¸è¶³

**é”™è¯¯ä¿¡æ¯ï¼š**
```
Error from server (Forbidden): pods is forbidden
```

**è§£å†³æ–¹æ³•ï¼š**
```bash
# æ£€æŸ¥å½“å‰ç”¨æˆ·æƒé™
kubectl auth can-i get pods --all-namespaces
kubectl auth can-i delete pods --all-namespaces
kubectl auth can-i patch nodes

# åº”ç”¨ RBAC é…ç½®
kubectl apply -f rbac.yaml
```

#### 2. èŠ‚ç‚¹æ±¡ç‚¹æœªç”Ÿæ•ˆ

**æ£€æŸ¥æ±¡ç‚¹ï¼š**
```bash
kubectl describe node <node-name> | grep -A 5 Taints
```

**æ‰‹åŠ¨æ·»åŠ æ±¡ç‚¹ï¼š**
```bash
kubectl taint nodes <node-name> node-role.kubernetes.io/RescuePod=true:NoSchedule --overwrite
```

#### 3. Pod æ— æ³•è¢«åˆ é™¤

**æ£€æŸ¥ PodDisruptionBudgetï¼š**
```bash
kubectl get pdb --all-namespaces
```

**å¼ºåˆ¶åˆ é™¤ï¼š**
```bash
kubectl delete pod <pod-name> -n <namespace> --force --grace-period=0
```

#### 4. ç¨‹åºæ— æ³•è¿æ¥é›†ç¾¤

**æ£€æŸ¥ kubeconfigï¼š**
```bash
kubectl get node
echo $KUBECONFIG
ls -la ~/.kube/config
```

**è®¾ç½®ç¯å¢ƒå˜é‡ï¼š**
```bash
export KUBECONFIG=/path/to/your/kubeconfig
```

## â“ FAQ

### Q1: ç¨‹åºä¼šåˆ é™¤å“ªäº› Podï¼Ÿ

**A:** åªåˆ é™¤æ»¡è¶³ä»¥ä¸‹æ¡ä»¶çš„ Podï¼š
- æœ‰æ§åˆ¶å™¨ï¼ˆDeploymentã€StatefulSetã€ReplicaSetï¼‰
- è¿è¡Œåœ¨å¼‚å¸¸èŠ‚ç‚¹ä¸Š
- ä¸”é›†ç¾¤ä¸­æœ‰å…¶ä»–å¯ç”¨èŠ‚ç‚¹

### Q2: ä¼šå½±å“ DaemonSet å—ï¼Ÿ

**A:** ä¸ä¼šã€‚ç¨‹åºåªå¤„ç†æœ‰æ§åˆ¶å™¨çš„æ™®é€š Podï¼ŒDaemonSet ç”± K8s è‡ªåŠ¨ç®¡ç†ã€‚

### Q3: èŠ‚ç‚¹æ¢å¤åä¼šè‡ªåŠ¨è§£é™¤éš”ç¦»å—ï¼Ÿ

**A:** ä¼šã€‚ç¨‹åºæ¯åˆ†é’Ÿæ£€æŸ¥è¢«éš”ç¦»èŠ‚ç‚¹ï¼Œå‘ç°æ¢å¤ Ready çŠ¶æ€åä¼šè‡ªåŠ¨ç§»é™¤æ±¡ç‚¹å¹¶ uncordonã€‚

### Q4: æ”¯æŒå¤šå‰¯æœ¬éƒ¨ç½²å—ï¼Ÿ

**A:** å»ºè®®å•å‰¯æœ¬è¿è¡Œã€‚å¤šå‰¯æœ¬å¯èƒ½å¯¼è‡´é‡å¤æ“ä½œã€‚

### Q5: å¦‚ä½•ç¡®ä¿å®‰å…¨æ€§ï¼Ÿ

**A:** 
- ä½¿ç”¨ RBAC æœ€å°æƒé™
- åªåœ¨æœ‰å¯ç”¨èŠ‚ç‚¹æ—¶æ¸…ç† Pod
- åªåˆ é™¤æœ‰æ§åˆ¶å™¨çš„ Pod
- è¯¦ç»†çš„æ“ä½œæ—¥å¿—è®°å½•

### Q6: ç¨‹åºå´©æºƒåä¼šä¸¢å¤±çŠ¶æ€å—ï¼Ÿ

**A:** ä¸ä¼šã€‚ç¨‹åºé‡‡ç”¨æ— çŠ¶æ€è®¾è®¡ï¼Œæ¯æ¬¡éƒ½æ ¹æ®å®é™…çŠ¶æ€åˆ¤æ–­ï¼Œé‡å¯åè‡ªåŠ¨æ¢å¤ã€‚

---

## âš ï¸ å…è´£å£°æ˜

æœ¬å·¥å…·ä¼šè‡ªåŠ¨åˆ é™¤ Pod å’Œæ“ä½œèŠ‚ç‚¹ï¼Œä½¿ç”¨å‰è¯·ï¼š
1. åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯
2. ç¡®ä¿æœ‰è¶³å¤Ÿçš„å¤‡ä»½
3. äº†è§£æ‰€æœ‰æ“ä½œçš„å½±å“
4. å»ºè®®å…ˆä»¥åªè¯»æ¨¡å¼è¿è¡Œè§‚å¯Ÿ

**ç”Ÿäº§ç¯å¢ƒä½¿ç”¨é£é™©è‡ªè´Ÿï¼**
